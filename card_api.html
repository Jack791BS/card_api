<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIVI Energia - Offerte</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vivi-magenta': '#E81C69', // Colore Fix
                        'vivi-orange': '#F09724',  // Colore Flex
                        'vivi-blue': '#077BBE',
                        'vivi-green': '#6EC18A',
                        'vivi-teal-dark': '#0085bd',
                        'vivi-teal-light': '#26a9e0',
                        'vivi-text': '#1d1d1f',
                        'vivi-gray': '#666666'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 30px -5px rgba(0, 0, 0, 0.15)',
                        'inner-box': '0 4px 15px rgba(0,0,0,0.05)'
                    },
                    backgroundImage: {
                        // Sfumature da Brandbook (image_b62814.png)
                        'gradient-luce': 'linear-gradient(90deg, #E81C69 0%, #F09724 100%)', // Magenta -> Arancio
                        'gradient-gas': 'linear-gradient(90deg, #077BBE 0%, #7E2889 100%)',  // Blu -> Viola
                        'gradient-dual': 'linear-gradient(90deg, #3AA3DA 0%, #6EC18A 100%)'  // Azzurro -> Verde
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f5f5f7; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Gestione Scrollbar Nascosta per slider mobile */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Tabs Style */
        .tab-btn { transition: all 0.3s ease; }
        /* Il background del tab attivo viene gestito via JS per applicare il gradiente corretto */
        .tab-active { color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 700; transform: scale(1.02); border: none; }
        .tab-inactive { color: #666; font-weight: 500; opacity: 0.8; background-color: transparent; }
        .tab-inactive:hover { opacity: 1; background-color: rgba(255,255,255,0.5); }

        /* Animazioni Card */
        .offer-card { transition: transform 0.3s ease; }
        .offer-card:hover { transform: translateY(-5px); }

        .dashed-line { border-top: 1px dashed #cbd5e1; margin: 15px 0; }
    </style>
</head>
<body class="p-4 md:p-10 flex flex-col items-center min-h-screen">

    <div class="w-full max-w-7xl mx-auto">
        
        <!-- Header / Tabs -->
        <div class="flex justify-center mb-10 relative z-10">
            <div class="bg-gray-200/60 p-1.5 rounded-full flex gap-1 backdrop-blur-md shadow-inner items-center">
                
                <!-- Tab Luce e Gas con Badge Centrato -->
                <div class="relative">
                    <!-- Badge posizionato assolutamente rispetto a questo wrapper -->
                    <span class="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-vivi-orange text-white text-[9px] font-bold px-2 py-0.5 rounded shadow-sm uppercase whitespace-nowrap z-20">La più conveniente</span>
                    
                    <button onclick="switchTab('dual')" id="tab-dual" class="tab-btn tab-active bg-gradient-dual px-6 py-3 rounded-full text-sm flex items-center gap-2">
                        <img src="https://vivienergia.imgix.net/uploads/2026/02/11155509/Dual_4.png" class="w-6 h-6 object-contain brightness-0 invert" alt="Dual">
                        <span>Luce e Gas</span>
                    </button>
                </div>

                <button onclick="switchTab('luce')" id="tab-luce" class="tab-btn tab-inactive px-6 py-3 rounded-full text-sm flex items-center gap-2">
                    <img src="https://vivienergia.imgix.net/uploads/2026/02/11155507/Luce_4B.png" class="w-6 h-6 object-contain opacity-60" alt="Luce">
                    <span>Luce</span>
                </button>
                <button onclick="switchTab('gas')" id="tab-gas" class="tab-btn tab-inactive px-6 py-3 rounded-full text-sm flex items-center gap-2">
                    <img src="https://vivienergia.imgix.net/uploads/2026/02/11155512/Gas_4.png" class="w-6 h-6 object-contain opacity-60" alt="Gas">
                    <span>Gas</span>
                </button>
            </div>
        </div>

        <!-- Loading / Error -->
        <div id="loading-ui" class="flex flex-col items-center py-20">
            <div class="w-10 h-10 border-4 border-gray-200 border-t-vivi-magenta rounded-full animate-spin mb-4"></div>
            <span class="text-gray-500 font-medium text-sm">Caricamento offerte...</span>
        </div>
        <div id="error-ui" class="hidden w-full max-w-lg mx-auto bg-white border border-red-200 rounded-xl p-4 text-center text-red-600 mb-8">
            <i class="fas fa-exclamation-circle mr-2"></i> Impossibile caricare i dati.
        </div>

        <!-- Cards Container -->
        <div id="cards-container" class="hidden w-full flex flex-row md:grid md:grid-cols-2 gap-6 md:gap-10 overflow-x-auto md:overflow-visible snap-x snap-mandatory no-scrollbar pb-8 px-4 md:px-0 items-stretch">
            
            <!-- 1. CARD PREZZO FISSO (Magenta) -->
            <div class="min-w-[90vw] md:min-w-0 snap-center offer-card bg-white rounded-3xl shadow-card overflow-hidden border-2 border-transparent hover:border-vivi-magenta flex flex-col">
                <!-- Header Colorato -->
                <div class="bg-vivi-magenta p-6 text-center text-white relative">
                    <div class="text-sm font-medium opacity-90 mb-1" id="fix-name">VIVIconsapevole Fix</div>
                    <h2 class="text-3xl font-extrabold uppercase tracking-tight">PREZZO FISSO</h2>
                </div>

                <!-- Body Contenuto -->
                <div class="p-6 pt-8 flex-grow flex flex-col bg-gradient-to-b from-pink-50/50 to-white">
                    <div class="text-center mb-6">
                        <div class="text-vivi-magenta font-bold text-sm bg-pink-100/50 inline-block px-4 py-1.5 rounded-lg mb-4" id="fix-desc">
                            Prezzo bloccato per due anni
                        </div>
                        <div class="dashed-line opacity-30"></div>
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">DEDICATA A CHI...</h4>
                        <p class="text-sm text-gray-600 leading-relaxed px-4">
                            Desidera stabilità nei costi per la propria casa con un <strong>prezzo fisso garantito per 24 mesi</strong>.
                        </p>
                    </div>

                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center gap-2 text-vivi-teal-light font-bold text-lg">
                            <i class="fas fa-check-circle"></i>
                            <span id="fix-main-bonus">BONUS FINO A ---€*</span>
                        </div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide mt-1" id="fix-bonus-sub">attivando...</p>
                    </div>

                    <div class="text-center mb-8">
                        <button class="bg-vivi-magenta text-white font-bold py-3.5 px-10 rounded-full shadow-lg hover:bg-pink-700 transition-all transform hover:-translate-y-0.5 text-sm uppercase tracking-wide w-full md:w-auto">
                            Passa a VIVI energia
                        </button>
                    </div>

                    <div id="fix-boxes-container" class="space-y-5 mt-auto">
                        <!-- Inseriti via JS -->
                    </div>
                    
                    <div class="text-center mt-5">
                        <a href="#" class="text-xs text-gray-400 underline hover:text-vivi-magenta">Scopri il dettaglio dei costi</a>
                    </div>
                </div>
            </div>

            <!-- 2. CARD PREZZO VARIABILE (Arancio) -->
            <div class="min-w-[90vw] md:min-w-0 snap-center offer-card bg-white rounded-3xl shadow-card overflow-hidden border-2 border-transparent hover:border-vivi-orange flex flex-col">
                <!-- Header Colorato -->
                <div class="bg-vivi-orange p-6 text-center text-white relative">
                    <div class="text-sm font-medium opacity-90 mb-1" id="flex-name">VIVIconsapevole Flex</div>
                    <h2 class="text-3xl font-extrabold uppercase tracking-tight">PREZZO VARIABILE</h2>
                </div>

                <!-- Body Contenuto -->
                <div class="p-6 pt-8 flex-grow flex flex-col bg-gradient-to-b from-orange-50/50 to-white">
                    <div class="text-center mb-6">
                        <div class="text-vivi-orange font-bold text-sm bg-orange-100/50 inline-block px-4 py-1.5 rounded-lg mb-4" id="flex-desc">
                            Prezzo indicizzato, variabile mensilmente
                        </div>
                        <div class="dashed-line opacity-30"></div>
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">DEDICATA A CHI...</h4>
                        <p class="text-sm text-gray-600 leading-relaxed px-4">
                            Desidera un'offerta che colga le <strong>opportunità di variazione dei prezzi nel mercato</strong>.
                        </p>
                    </div>

                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center gap-2 text-vivi-teal-light font-bold text-lg">
                            <i class="fas fa-check-circle"></i>
                            <span id="flex-main-bonus">BONUS FINO A ---€*</span>
                        </div>
                        <p class="text-xs text-gray-400 uppercase tracking-wide mt-1" id="flex-bonus-sub">attivando...</p>
                    </div>

                    <div class="text-center mb-8">
                        <button class="bg-vivi-orange text-white font-bold py-3.5 px-10 rounded-full shadow-lg hover:bg-orange-600 transition-all transform hover:-translate-y-0.5 text-sm uppercase tracking-wide w-full md:w-auto">
                            Passa a VIVI energia
                        </button>
                    </div>

                    <div id="flex-boxes-container" class="space-y-5 mt-auto">
                        <!-- Inseriti via JS -->
                    </div>

                    <div class="text-center mt-5">
                        <a href="#" class="text-xs text-gray-400 underline hover:text-vivi-orange">Scopri il dettaglio dei costi</a>
                    </div>
                </div>
            </div>

        </div>

        <div class="flex md:hidden justify-center gap-2 mt-4">
            <div class="w-2 h-2 rounded-full bg-gray-400"></div>
            <div class="w-2 h-2 rounded-full bg-gray-200"></div>
        </div>

    </div>

    <!-- TEMPLATE BOX BIANCO -->
    <template id="white-box-template">
        <div class="bg-white rounded-2xl shadow-inner-box p-6 relative border border-gray-100">
            <!-- Badge Bonus (Sfumatura Dinamica) -->
            <div class="absolute -top-3 right-6 text-white px-4 py-1.5 rounded-bl-xl rounded-tr-xl text-xs font-bold shadow-md flex flex-col items-center leading-tight bonus-badge-container">
                <span class="text-[9px] opacity-90 font-medium">BONUS fino a</span>
                <span class="text-base box-bonus-val">132€*</span>
            </div>

            <!-- Header: Icona + Titolo -->
            <div class="flex items-center gap-4 mb-5">
                <!-- ICONA E SFONDO INGRANDITI -->
                <!-- Applicazione gradiente tramite JS -->
                <div class="w-20 h-20 rounded-full flex items-center justify-center text-white text-lg box-icon-bg shadow-md">
                    <img src="" alt="Icon" class="box-icon-img w-12 h-12 object-contain brightness-0 invert">
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-800 text-lg box-title">Luce</span>
                        <span class="hidden box-green-tag border border-green-500 text-green-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase flex items-center gap-1">
                            <i class="fas fa-leaf"></i> 100% Green
                        </span>
                    </div>
                </div>
            </div>

            <!-- Content: Fasce / Prezzi -->
            <div class="box-price-content space-y-2.5">
                <!-- Rows injected here -->
            </div>

            <!-- Divider -->
            <div class="dashed-line"></div>

            <!-- Quota Fissa -->
            <div class="flex justify-between items-end">
                <div>
                    <div class="text-xs font-bold text-gray-700">Quota fissa</div>
                    <div class="text-[9px] text-gray-400">IVA e imposte escluse</div>
                </div>
                <div class="text-lg font-bold text-gray-800 box-quota-val">10 €/mese</div>
            </div>
        </div>
    </template>

    <script>
        // --- CONFIGURAZIONE ---
        const CONFIG = {
            dual: { 
                fix: 46402, 
                flex: 46404, 
                label: 'Luce e Gas', 
                cond: 'luce e gas' 
            },
            luce: { 
                fix: 46401, 
                flex: 46406, 
                label: 'Luce', 
                cond: 'luce' 
            },
            gas:  { 
                fix: 46403, 
                flex: 46405, 
                label: 'Gas', 
                cond: 'gas' 
            }
        };

        const API_BASE = "https://backend-funnel.vivienergia.it/api/wordpress/offer?id=";
        let currentTab = 'dual';

        // --- CORE LOGIC ---

        function switchTab(tab) {
            currentTab = tab;
            
            // Update UI Tabs - Applica gradiente al tab attivo
            ['dual', 'luce', 'gas'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const img = btn.querySelector('img');
                
                // Reset stati
                btn.className = "tab-btn tab-inactive px-6 py-3 rounded-full text-sm flex items-center gap-2";
                img.classList.add('opacity-60');
                img.classList.remove('brightness-0', 'invert');

                if (t === tab) {
                    btn.classList.remove('tab-inactive');
                    btn.classList.add('tab-active');
                    
                    // Applica Sfumature Corrette ai Tab Attivi
                    if(t === 'dual') btn.classList.add('bg-gradient-dual'); // Azzurro-Verde
                    else if(t === 'luce') btn.classList.add('bg-gradient-luce'); // Magenta-Arancio
                    else if(t === 'gas') btn.classList.add('bg-gradient-gas'); // Blu-Viola
                    
                    img.classList.remove('opacity-60');
                    img.classList.add('brightness-0', 'invert'); // Icona bianca su gradiente
                }
            });

            fetchData();
        }

        async function fetchData() {
            const loading = document.getElementById('loading-ui');
            const error = document.getElementById('error-ui');
            const container = document.getElementById('cards-container');

            loading.classList.remove('hidden');
            error.classList.add('hidden');
            container.classList.add('hidden');

            try {
                const fixId = CONFIG[currentTab].fix;
                const flexId = CONFIG[currentTab].flex;

                const [fixData, flexData] = await Promise.all([
                    fetch(`${API_BASE}${fixId}`).then(r => r.json()),
                    fetch(`${API_BASE}${flexId}`).then(r => r.json())
                ]);

                renderCard('fix', fixData);
                renderCard('flex', flexData);

                loading.classList.add('hidden');
                container.classList.remove('hidden');
                container.scrollLeft = 0;

            } catch (e) {
                console.error(e);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
            }
        }

        function renderCard(type, data) {
            const prefix = type;
            document.getElementById(`${prefix}-name`).textContent = data.nomeOfferta || `VIVIconsapevole ${type === 'fix' ? 'Fix' : 'Flex'}`;
            
            if (data.testoDescrittivo && data.testoDescrittivo.length > 0) {
                document.getElementById(`${prefix}-desc`).textContent = data.testoDescrittivo[0].value;
            }

            let totalBonus = 0;
            if (data.totaleBonus) {
                data.totaleBonus.forEach(b => {
                    const v = parseInt(b.valueCard.replace(/[^0-9]/g, ''));
                    if(!isNaN(v)) totalBonus += v;
                });
            }
            if (currentTab === 'dual' && totalBonus < 150 && totalBonus > 0) totalBonus *= 2; 
            if (totalBonus === 0) totalBonus = currentTab === 'dual' ? 264 : 132;

            document.getElementById(`${prefix}-main-bonus`).textContent = `BONUS FINO A ${totalBonus}€*`;
            document.getElementById(`${prefix}-bonus-sub`).textContent = `attivando ${CONFIG[currentTab].cond}`;

            const container = document.getElementById(`${prefix}-boxes-container`);
            container.innerHTML = '';

            const services = currentTab === 'dual' ? ['luce', 'gas'] : [currentTab];
            services.forEach(svc => {
                container.appendChild(createWhiteBox(svc, data, type));
            });
        }

        function createWhiteBox(svcType, data, offerType) {
            const template = document.getElementById('white-box-template');
            const clone = template.content.cloneNode(true);
            const isLuce = svcType === 'luce';

            // Elementi
            const iconBg = clone.querySelector('.box-icon-bg');
            const iconImg = clone.querySelector('.box-icon-img');
            const bonusBadge = clone.querySelector('.bonus-badge-container');
            
            if (isLuce) {
                // Stile LUCE
                // Sfumatura SFONDO Icona: Magenta -> Arancio
                iconBg.classList.add('bg-gradient-luce'); 
                iconImg.src = "https://vivienergia.imgix.net/uploads/2026/02/11155507/Luce_4B.png";
                clone.querySelector('.box-title').textContent = 'Luce';
                clone.querySelector('.box-green-tag').classList.remove('hidden');
                // Sfumatura Badge Bonus: Magenta -> Arancio
                bonusBadge.classList.add('bg-gradient-luce');
            } else {
                // Stile GAS
                // Sfumatura SFONDO Icona: Blu -> Viola
                iconBg.classList.add('bg-gradient-gas');
                iconImg.src = "https://vivienergia.imgix.net/uploads/2026/02/11155512/Gas_4.png";
                clone.querySelector('.box-title').textContent = 'Gas';
                // Sfumatura Badge Bonus: Blu -> Viola
                bonusBadge.classList.add('bg-gradient-gas');
            }

            // Bonus specifico
            let boxBonus = "132€";
            if(data.totaleBonus) {
                const b = data.totaleBonus.find(x => x.label && x.label.toLowerCase() === svcType);
                if(b) boxBonus = b.valueCard;
            }
            clone.querySelector('.box-bonus-val').textContent = boxBonus + '*';

            // Contenuto Prezzi
            const contentDiv = clone.querySelector('.box-price-content');
            const priceTitle = document.createElement('div');
            priceTitle.className = "text-xs font-bold text-gray-700 mb-3";
            priceTitle.textContent = offerType === 'fix' ? 
                `Prezzo ${isLuce ? 'energia' : 'gas'} bloccato per due anni` : 
                `Prezzo ${isLuce ? 'energia' : 'gas'}`;
            contentDiv.appendChild(priceTitle);

            if (offerType === 'fix') {
                if (isLuce) {
                    const fasce = data.energyBio || data.energy || [];
                    if (fasce.length === 0) {
                        fasce.push({label: "Fascia 1", value: "0,1177 €/kWh"});
                        fasce.push({label: "Fascia 2", value: "0,1288 €/kWh"});
                        fasce.push({label: "Fascia 3", value: "0,1076 €/kWh"});
                    }
                    fasce.forEach(f => {
                        const row = document.createElement('div');
                        row.className = "flex justify-between items-center text-sm";
                        row.innerHTML = `<span class="text-gray-500">${f.label}</span><span class="font-bold text-gray-800">${f.value}</span>`;
                        contentDiv.appendChild(row);
                    });
                } else {
                    let val = "0,3830 €/Smc";
                    if(data.gas && data.gas.length > 0) val = data.gas[0].value;
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center text-sm";
                    row.innerHTML = `<span class="text-gray-500">Materia prima</span><span class="font-bold text-gray-800 text-lg">${val}</span>`;
                    contentDiv.appendChild(row);
                }
            } else {
                const indexName = isLuce ? 'PUN' : 'PSV';
                let spread = isLuce ? "0,0145 €/kWh" : "0,095 €/Smc";
                const searchArr = isLuce ? 
                    [data.energyBioCommercialization, data.energyCommercialization, data.energyBio] :
                    [data.gasCommercialization, data.gas];
                
                const findSpread = () => {
                    for(const arr of searchArr) {
                        if(!arr) continue;
                        const item = arr.find(x => x.label && (x.label.toLowerCase().includes('quota variabile') || x.label.toLowerCase().includes('spread')));
                        if(item) return item.value;
                    }
                    return null;
                };
                const foundSpread = findSpread();
                if(foundSpread) spread = foundSpread;

                if (isLuce) {
                    ['Fascia 1', 'Fascia 2', 'Fascia 3'].forEach((f, idx) => {
                        const row = document.createElement('div');
                        row.className = "flex justify-between items-center text-sm min-h-[24px]";
                        if (idx === 1) {
                            row.innerHTML = `<span class="text-gray-500">${f}</span><span class="font-bold text-gray-800 text-base">${indexName} + ${spread}</span>`;
                        } else {
                            row.innerHTML = `<span class="text-gray-500">${f}</span>`;
                        }
                        contentDiv.appendChild(row);
                    });
                } else {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center text-sm";
                    row.innerHTML = `<span class="text-gray-500">Prezzo gas</span><span class="font-bold text-gray-800 text-lg">${indexName} + ${spread}</span>`;
                    contentDiv.appendChild(row);
                }
            }

            const commArr = isLuce ? (data.energyBioCommercialization || data.energyCommercialization) : data.gasCommercialization;
            let quota = "10 €/mese";
            if(commArr) {
                const q = commArr.find(x => x.label.toLowerCase().includes('quota fissa'));
                if(q) quota = q.value;
            }
            clone.querySelector('.box-quota-val').textContent = quota;

            return clone;
        }

        document.addEventListener('DOMContentLoaded', () => {
            switchTab('dual');
        });

    </script>
</body>
</html>
