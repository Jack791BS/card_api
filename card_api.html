<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIVI Energia - Offerte</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vivi-magenta': '#E81C69',
                        'vivi-orange': '#F09724',
                        'vivi-blue': '#077BBE',
                        'vivi-green': '#6EC18A',
                        'vivi-teal-dark': '#0085bd',
                        'vivi-teal-light': '#26a9e0',
                        'vivi-text': '#1d1d1f',
                        'vivi-gray': '#666666',
                        'vivi-price': '#445166'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 30px -5px rgba(0, 0, 0, 0.15)',
                        'inner-box': '0 4px 15px rgba(0,0,0,0.05)'
                    },
                    backgroundImage: {
                        'gradient-luce': 'linear-gradient(90deg, #E81C69 0%, #F09724 100%)',
                        'gradient-gas': 'linear-gradient(90deg, #077BBE 0%, #7E2889 100%)',
                        'gradient-dual': 'linear-gradient(90deg, #3AA3DA 0%, #6EC18A 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: transparent; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tab-btn { transition: all 0.3s ease; }
        .tab-active { color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 700; transform: scale(1.02); border: none; }
        .tab-inactive { color: #666; font-weight: 500; opacity: 0.8; background-color: transparent; }
        .tab-inactive:hover { opacity: 1; background-color: rgba(255,255,255,0.5); }

        .offer-card { transition: transform 0.3s ease, opacity 0.3s ease; }
        .offer-card:hover { transform: translateY(-5px); }

        .dashed-line { border-top: 1px dashed #cbd5e1; margin: 12px 0; }
        @media (min-width: 768px) {
            .dashed-line { margin: 15px 0; }
        }
        .snap-start-padding { scroll-padding-left: 1rem; }

        /* Custom Select Style */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }

        /* Modal Styles */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="p-2 md:p-10 flex flex-col items-center min-h-screen">

    <div class="w-full max-w-7xl mx-auto">
        
        <!-- Header Container: Tabs + Filtro -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 mb-4 md:mb-6 relative z-10">
            
            <!-- Main Tabs -->
            <div class="bg-gray-200/60 p-1 md:p-1.5 rounded-full flex gap-1 backdrop-blur-md shadow-inner items-center scale-90 md:scale-100 origin-center">
                <div class="relative">
                    <span class="absolute -top-4 md:-top-5 left-1/2 transform -translate-x-1/2 bg-vivi-orange text-white text-[8px] md:text-[9px] font-bold px-2 py-0.5 rounded shadow-sm uppercase whitespace-nowrap z-20">La più conveniente</span>
                    <button onclick="switchTab('dual')" id="tab-dual" class="tab-btn tab-active bg-gradient-dual px-4 py-2 md:px-6 md:py-3 rounded-full text-xs md:text-sm flex items-center gap-2">
                        <img src="https://storage.googleapis.com/instapage-user-media/c4efe85c/65046328-0-icone-lucegas-bianco.png" class="w-8 h-8 md:w-10 md:h-10 object-contain" alt="Dual">
                        <span>Luce e Gas</span>
                    </button>
                </div>

                <button onclick="switchTab('luce')" id="tab-luce" class="tab-btn tab-inactive px-4 py-2 md:px-6 md:py-3 rounded-full text-xs md:text-sm flex items-center gap-2">
                    <img src="https://storage.googleapis.com/instapage-user-media/c4efe85c/65046326-0-icone-luce-bianco.png" class="w-8 h-8 md:w-10 md:h-10 object-contain opacity-60 brightness-0" alt="Luce">
                    <span>Luce</span>
                </button>
                <button onclick="switchTab('gas')" id="tab-gas" class="tab-btn tab-inactive px-4 py-2 md:px-6 md:py-3 rounded-full text-xs md:text-sm flex items-center gap-2">
                    <img src="https://storage.googleapis.com/instapage-user-media/c4efe85c/65046324-0-icone-gas-bianco.png" class="w-8 h-8 md:w-10 md:h-10 object-contain opacity-60 brightness-0" alt="Gas">
                    <span>Gas</span>
                </button>
            </div>

            <!-- Filtro Secondario -->
            <div class="relative group">
                <select id="filter-select" onchange="applyFilter(this.value)" class="custom-select appearance-none bg-white/50 hover:bg-white border border-transparent hover:border-gray-200 text-gray-600 font-medium text-xs md:text-sm rounded-full py-1.5 pl-3 pr-7 md:py-2 md:pl-4 md:pr-8 shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-vivi-teal-light cursor-pointer">
                    <option value="all">Mostra tutte le offerte</option>
                    <option value="fix">Solo Prezzo Fisso</option>
                    <option value="flex">Solo Prezzo Variabile</option>
                </select>
            </div>

        </div>

        <!-- Loading / Error -->
        <div id="loading-ui" class="flex flex-col items-center py-10 md:py-20">
            <div class="w-8 h-8 md:w-10 md:h-10 border-4 border-gray-200 border-t-vivi-magenta rounded-full animate-spin mb-4"></div>
            <span class="text-gray-500 font-medium text-xs md:text-sm">Caricamento offerte...</span>
        </div>
        <div id="error-ui" class="hidden w-full max-w-lg mx-auto bg-white border border-red-200 rounded-xl p-4 text-center text-red-600 mb-8">
            <i class="fas fa-exclamation-circle mr-2"></i> Impossibile caricare i dati.
        </div>

        <!-- Cards Container -->
        <div id="cards-container" class="hidden w-full flex flex-row md:grid md:grid-cols-2 gap-3 md:gap-10 overflow-x-auto md:overflow-visible snap-x snap-mandatory snap-start-padding no-scrollbar pb-6 md:pb-8 px-2 md:px-0 items-stretch transition-all duration-300">
            
            <!-- 1. CARD PREZZO FISSO -->
            <div id="card-fix" class="min-w-[85vw] md:min-w-0 snap-center offer-card bg-white rounded-2xl md:rounded-3xl shadow-card overflow-hidden border-2 border-transparent hover:border-vivi-magenta flex flex-col transition-all duration-300">
                <div class="bg-vivi-magenta p-4 md:p-6 text-center text-white relative">
                    <div class="text-xs md:text-sm font-medium opacity-90 mb-1" id="fix-name">VIVIconsapevole Fix</div>
                    <h2 class="text-2xl md:text-3xl font-extrabold uppercase tracking-tight">PREZZO FISSO</h2>
                </div>

                <div class="p-4 md:p-8 flex-grow flex flex-col bg-gradient-to-b from-pink-50/50 to-white">
                    <div class="text-center mb-4 md:mb-6">
                        <div class="text-vivi-magenta font-bold text-xs md:text-sm bg-pink-100/50 inline-block px-3 py-1 md:px-4 md:py-1.5 rounded-lg mb-3 md:mb-4" id="fix-desc">
                            Prezzo bloccato per due anni
                        </div>
                        <div class="dashed-line opacity-30"></div>
                        <h4 class="text-[10px] md:text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 md:mb-2">DEDICATA A CHI...</h4>
                        <p class="text-xs md:text-sm text-gray-600 leading-relaxed px-2 md:px-4">
                            Desidera stabilità nei costi per la propria casa con un <strong>prezzo fisso garantito per 24 mesi</strong>.
                        </p>
                    </div>

                    <div class="text-center mb-4 md:mb-6">
                        <div class="flex items-center justify-center gap-2 text-vivi-teal-light font-bold text-base md:text-lg">
                            <i class="fas fa-check-circle"></i>
                            <span id="fix-main-bonus">BONUS FINO A ---€*</span>
                        </div>
                        <p class="text-[10px] md:text-xs text-gray-400 uppercase tracking-wide mt-1" id="fix-bonus-sub">attivando...</p>
                    </div>

                    <div class="text-center mb-6 md:mb-8">
                        <a id="cta-fix" href="#" class="inline-block bg-vivi-magenta text-white font-bold py-3 px-8 md:py-3.5 md:px-10 rounded-full shadow-lg hover:bg-pink-700 transition-all transform hover:-translate-y-0.5 text-xs md:text-sm uppercase tracking-wide w-full md:w-auto text-center">
                            Passa a VIVI energia
                        </a>
                    </div>

                    <div id="fix-boxes-container" class="space-y-3 md:space-y-5 mt-auto"></div>
                    
                    <div class="text-center mt-4 md:mt-5">
                        <a href="javascript:void(0)" onclick="openModal('fix')" class="text-[10px] md:text-xs text-gray-400 underline hover:text-vivi-magenta cursor-pointer">Scopri il dettaglio dei costi</a>
                    </div>
                </div>
            </div>

            <!-- 2. CARD PREZZO VARIABILE -->
            <div id="card-flex" class="min-w-[85vw] md:min-w-0 snap-center offer-card bg-white rounded-2xl md:rounded-3xl shadow-card overflow-hidden border-2 border-transparent hover:border-vivi-orange flex flex-col transition-all duration-300">
                <div class="bg-vivi-orange p-4 md:p-6 text-center text-white relative">
                    <div class="text-xs md:text-sm font-medium opacity-90 mb-1" id="flex-name">VIVIconsapevole Flex</div>
                    <h2 class="text-2xl md:text-3xl font-extrabold uppercase tracking-tight">PREZZO VARIABILE</h2>
                </div>

                <div class="p-4 md:p-8 flex-grow flex flex-col bg-gradient-to-b from-orange-50/50 to-white">
                    <div class="text-center mb-4 md:mb-6">
                        <div class="text-vivi-orange font-bold text-xs md:text-sm bg-orange-100/50 inline-block px-3 py-1 md:px-4 md:py-1.5 rounded-lg mb-3 md:mb-4" id="flex-desc">
                            Prezzo indicizzato, variabile mensilmente
                        </div>
                        <div class="dashed-line opacity-30"></div>
                        <h4 class="text-[10px] md:text-xs font-bold text-gray-500 uppercase tracking-widest mb-1 md:mb-2">DEDICATA A CHI...</h4>
                        <p class="text-xs md:text-sm text-gray-600 leading-relaxed px-2 md:px-4">
                            Desidera un'offerta che colga le <strong>opportunità di variazione dei prezzi nel mercato</strong>.
                        </p>
                    </div>

                    <div class="text-center mb-4 md:mb-6">
                        <div class="flex items-center justify-center gap-2 text-vivi-teal-light font-bold text-base md:text-lg">
                            <i class="fas fa-check-circle"></i>
                            <span id="flex-main-bonus">BONUS FINO A ---€*</span>
                        </div>
                        <p class="text-[10px] md:text-xs text-gray-400 uppercase tracking-wide mt-1" id="flex-bonus-sub">attivando...</p>
                    </div>

                    <div class="text-center mb-6 md:mb-8">
                        <a id="cta-flex" href="#" class="inline-block bg-vivi-orange text-white font-bold py-3 px-8 md:py-3.5 md:px-10 rounded-full shadow-lg hover:bg-orange-600 transition-all transform hover:-translate-y-0.5 text-xs md:text-sm uppercase tracking-wide w-full md:w-auto text-center">
                            Passa a VIVI energia
                        </a>
                    </div>

                    <div id="flex-boxes-container" class="space-y-3 md:space-y-5 mt-auto"></div>

                    <div class="text-center mt-4 md:mt-5">
                        <a href="javascript:void(0)" onclick="openModal('flex')" class="text-[10px] md:text-xs text-gray-400 underline hover:text-vivi-orange cursor-pointer">Scopri il dettaglio dei costi</a>
                    </div>
                </div>
            </div>

        </div>

        <div class="flex md:hidden justify-center gap-2 mt-4" id="mobile-dots">
            <div class="w-2 h-2 rounded-full bg-gray-400 dot-indicator" data-target="fix"></div>
            <div class="w-2 h-2 rounded-full bg-gray-200 dot-indicator" data-target="flex"></div>
        </div>

    </div>

    <!-- MODAL DETTAGLI -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col relative overflow-hidden">
            <!-- Header Modal -->
            <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-white z-10">
                <h3 class="text-xl font-bold text-vivi-price text-center w-full">Dettagli offerta</h3>
                <button onclick="closeModal()" class="absolute right-5 text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Body Modal (Scrollable) -->
            <div id="modal-content" class="p-6 overflow-y-auto modal-content-scroll bg-slate-50/50">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- TEMPLATE BOX BIANCO (Main Cards) -->
    <template id="white-box-template">
        <div class="bg-white rounded-xl md:rounded-2xl shadow-inner-box p-4 md:p-6 relative border border-gray-100">
            <div class="absolute -top-3 right-4 md:right-6 text-white px-3 py-1.5 md:px-5 md:py-2 rounded-bl-xl rounded-tr-xl shadow-md flex flex-col items-center leading-tight bonus-badge-container">
                <span class="text-[9px] md:text-[10px] opacity-90 font-medium">BONUS fino a</span>
                <span class="text-lg md:text-2xl font-bold box-bonus-val">132€*</span>
            </div>
            <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-5">
                <div class="w-16 h-16 md:w-20 md:h-20 flex items-center justify-center text-white text-lg box-icon-bg p-0 flex-shrink-0">
                    <img src="" alt="Icon" class="box-icon-img w-full h-full object-contain">
                </div>
                <div class="flex flex-col justify-center">
                    <span class="font-bold text-gray-800 text-base md:text-lg box-title leading-none">Luce</span>
                    <span class="hidden box-green-tag mt-1 flex items-start gap-1"></span>
                </div>
            </div>
            <div class="box-price-content space-y-1.5 md:space-y-2.5"></div>
            <div class="dashed-line"></div>
            <div class="flex justify-between items-end">
                <div>
                    <div class="text-[10px] md:text-xs font-bold text-gray-700">Quota fissa</div>
                    <div class="text-[8px] md:text-[9px] text-gray-400">IVA e imposte escluse</div>
                </div>
                <div class="text-base md:text-lg font-bold text-vivi-price box-quota-val">10 €/mese</div>
            </div>
        </div>
    </template>

    <script>
        const CONFIG = {
            dual: { fix: 46402, flex: 46404, label: 'Luce e Gas', cond: 'luce e gas' },
            luce: { fix: 46401, flex: 46406, label: 'Luce', cond: 'luce' },
            gas:  { fix: 46403, flex: 46405, label: 'Gas', cond: 'gas' }
        };

        const API_BASE = "https://backend-funnel.vivienergia.it/api/wordpress/offer?id=";
        let currentTab = 'dual';
        let currentFilter = 'all';
        
        // Cache per i dati delle offerte
        let loadedOffers = { fix: null, flex: null };

        // --- CORE LOGIC ---
        function switchTab(tab) {
            currentTab = tab;
            ['dual', 'luce', 'gas'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const img = btn.querySelector('img');
                btn.className = "tab-btn tab-inactive px-4 py-2 md:px-6 md:py-3 rounded-full text-xs md:text-sm flex items-center gap-2";
                img.classList.add('opacity-60', 'brightness-0');
                img.classList.remove('invert');
                if (t === tab) {
                    btn.classList.remove('tab-inactive');
                    btn.classList.add('tab-active');
                    if(t === 'dual') btn.classList.add('bg-gradient-dual');
                    else if(t === 'luce') btn.classList.add('bg-gradient-luce');
                    else if(t === 'gas') btn.classList.add('bg-gradient-gas');
                    img.classList.remove('opacity-60', 'brightness-0');
                }
            });
            updateCtaLinks();
            fetchData();
        }

        function updateCtaLinks() {
            const utilityMap = { 'dual': 'Lucegas', 'luce': 'Luce', 'gas': 'Gas' };
            const utility = utilityMap[currentTab];
            const urlTemplate = `https://www.vivienergia.it/configurator?business=Privato&utility=${utility}&price={PRICE}&referrer=configuratore-lp-due-vivic-vb`;
            const ctaFix = document.getElementById('cta-fix');
            if(ctaFix) ctaFix.href = urlTemplate.replace('{PRICE}', 'fix');
            const ctaFlex = document.getElementById('cta-flex');
            if(ctaFlex) ctaFlex.href = urlTemplate.replace('{PRICE}', 'flex');
        }

        function applyFilter(filterType) {
            currentFilter = filterType;
            const container = document.getElementById('cards-container');
            const cardFix = document.getElementById('card-fix');
            const cardFlex = document.getElementById('card-flex');
            if (filterType === 'all') {
                cardFix.classList.remove('hidden');
                cardFlex.classList.remove('hidden');
                container.classList.add('md:grid', 'md:grid-cols-2');
                container.classList.remove('justify-center');
            } else {
                container.classList.remove('md:grid', 'md:grid-cols-2');
                container.classList.add('flex', 'justify-center');
                if (filterType === 'fix') {
                    cardFix.classList.remove('hidden');
                    cardFlex.classList.add('hidden');
                } else {
                    cardFix.classList.add('hidden');
                    cardFlex.classList.remove('hidden');
                }
            }
        }

        async function fetchData() {
            const loading = document.getElementById('loading-ui');
            const container = document.getElementById('cards-container');
            const errorContainer = document.getElementById('error-ui');

            loading.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            container.classList.add('hidden');

            try {
                const fixId = CONFIG[currentTab].fix;
                const flexId = CONFIG[currentTab].flex;

                const [fixData, flexData] = await Promise.all([
                    fetch(`${API_BASE}${fixId}`).then(r => r.json()),
                    fetch(`${API_BASE}${flexId}`).then(r => r.json())
                ]);

                // Save to cache for modal
                loadedOffers.fix = fixData;
                loadedOffers.flex = flexData;

                renderCard('fix', fixData);
                renderCard('flex', flexData);

                loading.classList.add('hidden');
                container.classList.remove('hidden');
                applyFilter(currentFilter);
                container.scrollLeft = 0;

            } catch (e) {
                console.error(e);
                loading.classList.add('hidden');
                errorContainer.classList.remove('hidden');
            }
        }

        function renderCard(type, data) {
            const prefix = type;
            document.getElementById(`${prefix}-name`).textContent = data.nomeOfferta || `VIVIconsapevole ${type === 'fix' ? 'Fix' : 'Flex'}`;
            
            if (data.testoDescrittivo && data.testoDescrittivo.length > 0) {
                document.getElementById(`${prefix}-desc`).textContent = data.testoDescrittivo[0].value;
            }

            let totalBonus = 0;
            if (data.totaleBonus) {
                data.totaleBonus.forEach(b => {
                    const v = parseInt(b.valueCard.replace(/[^0-9]/g, ''));
                    if(!isNaN(v)) totalBonus += v;
                });
            }
            if (currentTab === 'dual' && totalBonus < 150 && totalBonus > 0) totalBonus *= 2; 
            if (totalBonus === 0) totalBonus = currentTab === 'dual' ? 264 : 132;

            document.getElementById(`${prefix}-main-bonus`).textContent = `BONUS FINO A ${totalBonus}€*`;
            document.getElementById(`${prefix}-bonus-sub`).textContent = `attivando ${CONFIG[currentTab].cond}`;

            const container = document.getElementById(`${prefix}-boxes-container`);
            container.innerHTML = '';

            const services = currentTab === 'dual' ? ['luce', 'gas'] : [currentTab];
            services.forEach(svc => {
                container.appendChild(createWhiteBox(svc, data, type));
            });
        }

        function createWhiteBox(svcType, data, offerType) {
            const template = document.getElementById('white-box-template');
            const clone = template.content.cloneNode(true);
            const isLuce = svcType === 'luce';
            const iconBg = clone.querySelector('.box-icon-bg');
            const iconImg = clone.querySelector('.box-icon-img');
            const bonusBadge = clone.querySelector('.bonus-badge-container');
            iconImg.classList.remove('brightness-0', 'invert');

            if (isLuce) {
                iconImg.src = "https://storage.googleapis.com/instapage-user-media/c4efe85c/65694286-0-IconaBolla-Luce.svg";
                clone.querySelector('.box-title').textContent = 'Luce';
                const greenTag = clone.querySelector('.box-green-tag');
                greenTag.classList.remove('hidden');
                greenTag.innerHTML = `
                    <img src="https://v.fastcdn.co/t/4fe35e38/103c13e8/1769856097-65077022-30x30-eco-24dp-6EC18A-FILL.png" class="w-3 h-3 md:w-4 md:h-4 object-contain" alt="Green">
                    <span class="text-left text-vivi-green text-[9px] md:text-[10px] font-bold whitespace-nowrap">100% energia elettrica green</span>
                `;
                bonusBadge.classList.add('bg-gradient-luce');
            } else {
                iconImg.src = "https://storage.googleapis.com/instapage-user-media/c4efe85c/65694287-0-IconaBolla-Gas.svg";
                clone.querySelector('.box-title').textContent = 'Gas';
                bonusBadge.classList.add('bg-gradient-gas');
            }

            let boxBonus = "132€";
            if(data.totaleBonus) {
                const b = data.totaleBonus.find(x => x.label && x.label.toLowerCase() === svcType);
                if(b) boxBonus = b.valueCard;
            }
            clone.querySelector('.box-bonus-val').textContent = boxBonus + '*';

            const contentDiv = clone.querySelector('.box-price-content');
            const priceTitle = document.createElement('div');
            priceTitle.className = "text-[10px] md:text-xs font-bold text-gray-700 mb-2 md:mb-3";
            priceTitle.textContent = offerType === 'fix' ? 
                `Prezzo ${isLuce ? 'energia' : 'gas'} bloccato per due anni` : 
                `Prezzo ${isLuce ? 'energia' : 'gas'}`;
            contentDiv.appendChild(priceTitle);

            if (offerType === 'fix') {
                if (isLuce) {
                    const fasce = data.energyBio || data.energy || [];
                    if (fasce.length === 0) {
                        fasce.push({label: "Fascia 1", value: "0,1177 €/kWh"});
                        fasce.push({label: "Fascia 2", value: "0,1288 €/kWh"});
                        fasce.push({label: "Fascia 3", value: "0,1076 €/kWh"});
                    }
                    fasce.forEach(f => {
                        const row = document.createElement('div');
                        row.className = "flex justify-between items-center mb-1";
                        row.innerHTML = `<span class="text-gray-500 text-xs md:text-sm font-medium">${f.label}</span><span class="font-bold text-vivi-price text-base md:text-lg">${f.value}</span>`;
                        contentDiv.appendChild(row);
                    });
                } else {
                    let val = "0,3830 €/Smc";
                    if(data.gas && data.gas.length > 0) val = data.gas[0].value;
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center text-xs md:text-sm";
                    row.innerHTML = `<span class="text-gray-500">Materia prima</span><span class="font-bold text-vivi-price text-base md:text-lg">${val}</span>`;
                    contentDiv.appendChild(row);
                }
            } else {
                const indexName = isLuce ? 'PUN' : 'PSV';
                let spread = isLuce ? "0,0145 €/kWh" : "0,095 €/Smc";
                const searchArr = isLuce ? 
                    [data.energyBioCommercialization, data.energyCommercialization, data.energyBio] :
                    [data.gasCommercialization, data.gas];
                
                const findSpread = () => {
                    for(const arr of searchArr) {
                        if(!arr) continue;
                        const item = arr.find(x => x.label && (x.label.toLowerCase().includes('quota variabile') || x.label.toLowerCase().includes('spread')));
                        if(item) return item.value;
                    }
                    return null;
                };
                const foundSpread = findSpread();
                if(foundSpread) spread = foundSpread;

                if (isLuce) {
                    ['Fascia 1', 'Fascia 2', 'Fascia 3'].forEach((f, idx) => {
                        const row = document.createElement('div');
                        row.className = "flex justify-between items-center text-xs md:text-sm min-h-[20px] md:min-h-[24px]";
                        if (idx === 1) {
                            row.innerHTML = `<span class="text-gray-500">${f}</span><span class="font-bold text-vivi-price text-base md:text-lg">${indexName} + ${spread}</span>`;
                        } else {
                            row.innerHTML = `<span class="text-gray-500">${f}</span>`;
                        }
                        contentDiv.appendChild(row);
                    });
                } else {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center text-xs md:text-sm";
                    row.innerHTML = `<span class="text-gray-500">Prezzo gas</span><span class="font-bold text-vivi-price text-base md:text-lg">${indexName} + ${spread}</span>`;
                    contentDiv.appendChild(row);
                }
            }

            const commArr = isLuce ? (data.energyBioCommercialization || data.energyCommercialization) : data.gasCommercialization;
            let quota = "10 €/mese";
            if(commArr) {
                const q = commArr.find(x => x.label.toLowerCase().includes('quota fissa'));
                if(q) quota = q.value;
            }
            clone.querySelector('.box-quota-val').textContent = quota;

            return clone;
        }

        // --- MODAL LOGIC ---
        function openModal(type) {
            const data = loadedOffers[type];
            if (!data) return;

            const modal = document.getElementById('details-modal');
            const content = document.getElementById('modal-content');
            
            let html = '';
            
            const services = currentTab === 'dual' ? ['luce', 'gas'] : [currentTab];

            services.forEach(svc => {
                const isLuce = svc === 'luce';
                // USE BOLLE ICONS (SVG)
                const iconUrl = isLuce 
                    ? "https://storage.googleapis.com/instapage-user-media/c4efe85c/65694286-0-IconaBolla-Luce.svg" 
                    : "https://storage.googleapis.com/instapage-user-media/c4efe85c/65694287-0-IconaBolla-Gas.svg";
                const title = isLuce ? "Luce" : "Gas";
                
                // Header Sezione
                html += `
                    <div class="flex items-center gap-3 mb-4 mt-2">
                        <img src="${iconUrl}" class="w-8 h-8 object-contain" alt="${title}">
                        <h4 class="font-bold text-lg text-vivi-price">${title}</h4>
                    </div>
                `;

                // 1. Sezione Prezzi
                const priceHeader = isLuce ? 
                    (type === 'fix' ? 'Prezzo bloccato per due anni' : 'Prezzo energia') :
                    (type === 'fix' ? 'Prezzo bloccato per due anni' : 'Prezzo gas');
                
                html += `<div class="mb-4">
                    <h5 class="text-sm font-bold text-vivi-price mb-2">${priceHeader}</h5>`;
                
                if (isLuce) {
                    const energy = data.energyBio || [];
                    energy.forEach(e => {
                        html += `<div class="flex justify-between text-sm py-1 border-b border-gray-50 last:border-0">
                            <span class="text-gray-500">${e.label}</span>
                            <span class="font-bold text-vivi-price">${e.value}</span>
                        </div>`;
                    });
                } else {
                    const gas = data.gas || [];
                    gas.forEach(g => {
                        html += `<div class="flex justify-between text-sm py-1 border-b border-gray-50 last:border-0">
                            <span class="text-gray-500">${g.label}</span>
                            <span class="font-bold text-vivi-price">${g.value}</span>
                        </div>`;
                    });
                }
                html += `</div>`;

                // Costi Commercializzazione
                const commArr = isLuce ? 
                    (data.energyBioCommercialization || data.energyCommercialization || []) : 
                    (data.gasCommercialization || []);

                const costs = commArr.filter(i => i.label && !i.label.toLowerCase().includes('bonus'));
                if(costs.length > 0) {
                    html += `<div class="mb-4">
                        <h5 class="text-sm font-bold text-vivi-price mb-2">Costi di commercializzazione</h5>`;
                    costs.forEach(c => {
                        if(c.label.trim() === "") return; 
                        html += `<div class="flex justify-between text-sm py-1 border-b border-gray-50 last:border-0">
                            <span class="text-gray-500">${c.label}</span>
                            <span class="font-bold text-vivi-price">${c.value}</span>
                        </div>`;
                    });
                    html += `</div>`;
                }

                // Bonus
                const bonuses = commArr.filter(i => i.label && i.label.toLowerCase().includes('bonus'));
                const totalBonusObj = data.totaleBonus ? data.totaleBonus.find(b => b.label && b.label.toLowerCase() === svc) : null;
                
                if(bonuses.length > 0 || totalBonusObj) {
                    html += `<div class="mb-6">
                        <h5 class="text-sm font-bold text-vivi-price mb-2">Bonus</h5>`;
                    
                    bonuses.forEach(b => {
                        html += `<div class="flex justify-between text-sm py-1 border-b border-gray-50 last:border-0">
                            <span class="text-gray-500">${b.label}</span>
                            <span class="font-bold text-vivi-price">${b.value}</span>
                        </div>`;
                    });

                    if(totalBonusObj) {
                        html += `<div class="flex justify-between text-sm py-2 border-t border-gray-100 mt-1">
                            <span class="font-bold text-vivi-price">Totale Bonus*</span>
                            <span class="font-bold text-vivi-price">${totalBonusObj.value}</span>
                        </div>`;
                    }
                    html += `</div>`;
                }
            });

            if(data.noteEsplicative) {
                html += `<div class="text-[10px] text-gray-400 mt-6 leading-relaxed border-t border-gray-200 pt-4">
                    ${data.noteEsplicative}
                </div>`;
            }

            content.innerHTML = html;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('details-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        document.getElementById('details-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('DOMContentLoaded', () => {
            switchTab('dual');
        });

    </script>
</body>
</html>
